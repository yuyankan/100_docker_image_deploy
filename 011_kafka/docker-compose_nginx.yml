version: '3.8'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    hostname: zookeeper
    container_name: zookeeper
    restart: always 
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    # 宿主机访问端口
    ports:
      - "2181:2181"
    networks:
      - kafka_net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    hostname: kafka
    container_name: kafka
    restart: always 
    depends_on:
      - zookeeper
    
    # 【外部端口映射】：允许宿主机访问
    ports:
      - "9092:9092"
      
    environment:
      KAFKA_BROKER_ID: 1 
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 
      
      # =======================================================
      # 【核心网络修正：唯一命名监听器】
      # 避免 'Each listener must have a different name' 错误
      # =======================================================
      
      # 1. 监听器定义：INTERNAL 供容器内部使用，EXTERNAL 供外部使用
    
      
      # 2. 告知客户端连接地址：INTERNAL 告知 Python Producer (kafka:29092)，EXTERNAL 告知宿主机 (localhost:9092)
      # KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://10.161.81.13:9092
     
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:29092,EXTERNAL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://10.161.81.13:8010,INTERNAL://kafka:29092
      #KAFKA_ADVERTISED_LISTENERS: EXTERNAL://10.161.81.13:8010
      # 3. 监听器协议映射：明确指出 INTERNAL 和 EXTERNAL 都使用 PLAINTEXT 协议
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      
      # 单 Broker 优化配置
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      
    # 【Bind Mount 兼容修正（方法一）】
    # 宿主机路径:容器内部路径
    volumes:
      - ./kafka_data:/var/lib/kafka/data
      
    networks:
      - kafka_net

# =======================================================
# 【网络定义：使用您指定的名称】
# =======================================================

networks:
  kafka_net: # 内部别名
    external: true
    name: devcontainer_default # 外部网络名称 (供 Producer 容器引用)
