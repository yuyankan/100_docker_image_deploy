# ====================================================
# STAGE 1: 基础镜像和系统依赖
# ====================================================
FROM python_env_common:202507

# ----------------------------------------------------
# 代理配置：确保所有网络请求通过代理
# ----------------------------------------------------
# 修正了 HTTPS_PROXY 缺失的引号，确保所有网络操作使用代理
ENV HTTP_PROXY="http://gateway.zscalertwo.net:10090" \
    HTTPS_PROXY="http://gateway.zscalertwo.net:10090" \
    http_proxy="http://gateway.zscalertwo.net:10090" \
    https_proxy="http://gateway.zscalertwo.net:10090"

# ----------------------------------------------------
# 必装系统依赖：用于编译 av (PyAV) 和 opencv-python
# ----------------------------------------------------
# ❗ 关键：安装 FFmpeg 及其开发库。如果基础镜像是 Alpine，需要改为 apk 命令
RUN apt-get update && \
    # 安装 FFmpeg 及其开发库，用于 PyAV 编译
    apt-get install -y ffmpeg libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
    # 安装 OpenCV 的基本依赖（例如用于 GUI/X11，虽然 Docker 中通常不需要，但安全起见）
    libgl1-mesa-glx libsm6 libxext6 \
    # 清理 apt 缓存，减小镜像体积
    && rm -rf /var/lib/apt/lists/*

# ----------------------------------------------------
# 设置工作目录
# ----------------------------------------------------
WORKDIR /workspaces/my_project

# ====================================================
# STAGE 2: Python 依赖安装 (利用缓存)
# ====================================================

# ----------------------------------------------------
# 复制 requirements.txt 以利用 Docker 缓存
# ----------------------------------------------------
# 仅复制 requirements.txt。只有此文件更改时，下面的 RUN 才会重新执行。
COPY requirements.txt .

# ----------------------------------------------------
# 安装 Python 依赖
# ----------------------------------------------------
# 使用 --no-cache-dir 减少 pip 缓存，进一步减小镜像大小
RUN pip install --no-cache-dir -r requirements.txt

# ----------------------------------------------------
# 复制项目文件和设置权限
# ----------------------------------------------------
# 复制所有项目文件。放在最后，避免代码小变动导致前面层重建。
COPY . .

# ----------------------------------------------------
# Dev Containers/安全最佳实践 (可选)
# ----------------------------------------------------
# 推荐使用非 root 用户运行，增强安全性。
# 如果您的基础镜像中有名为 'user' 的非 root 用户，可以启用此行。
# USER user

# ====================================================
# 您的 requirements.txt 文件内容
# ====================================================
# requirements.txt:
# boto3
# confluent-kafka
# opencv-python
# av
