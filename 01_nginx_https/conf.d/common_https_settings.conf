# 该文件包含所有可重用的 HTTPS 配置和代理头。
# 可以在其他配置文件中通过 include 指令引用。

# SSL/TLS 证书路径，与 docker-compose.yml 中的卷映射保持一致
ssl_certificate /etc/nginx/certs/server.crt;
ssl_certificate_key /etc/nginx/certs/server.key;

# 推荐的 SSL 安全设置
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384';
ssl_prefer_server_ciphers on;

# 重要的代理头设置
# # 1. 核心：传递客户端的 Host 头
proxy_set_header Host $http_host;

# 3. 转发信息：传递真实IP
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

# 2. 关键：传递客户端的 Origin 头，解决 Origin Not Allowed/CSRF 问题
proxy_set_header Origin $http_origin;

# 4. 核心：告诉Grafana客户端使用的是HTTPS
proxy_set_header X-Forwarded-Proto $scheme;

#. 强制 Nginx 接收并传递 Cookie 头
proxy_set_header Cookie $http_cookie;
proxy_set_header X-Forwarded-Host $http_host;

proxy_redirect off;
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;
proxy_buffer_size 128k;
proxy_buffers 4 256k;
proxy_busy_buffers_size 256k;
