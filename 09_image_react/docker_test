ARG PUBLIC_DNS="8.8.8.8"

FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./

# 2. 核心修复：绕过锁定，强制覆盖 DNS
# ⚠️ 关键修改：将 nameserver 写入临时文件，然后使用 mv 覆盖 /etc/resolv.conf
# 这是绕过 'Resource busy' 错误的最可靠 shell 技巧。
RUN printf "nameserver %s\n" "${PUBLIC_DNS}" > /tmp/resolv.conf && mv /tmp/resolv.conf /etc/resolv.conf

# 3. 环境变量清除：清除可能残留的代理，避免干扰纯净连接
ENV HTTP_PROXY="" \
    HTTPS_PROXY="" \
    ALL_PROXY=""

# 4. 依赖安装：使用最兼容的 npm install 替代 npm ci
RUN npm install --legacy-peer-deps

COPY . .
# 生产构建（生成 dist 文件夹）
RUN npm run build

# ====== 阶段 2: 生产阶段 (nginx) ======
# 使用您的定制化 nginx 基础镜像
FROM my_nginx_image:202507

# 删除默认配置文件（可选，取决于您的基础镜像）
RUN rm -rf /etc/nginx/conf.d/*

# 拷贝我们自定义的 nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 从上一个阶段复制构建好的静态文件
COPY --from=builder /app/dist /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
